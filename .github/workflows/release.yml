name: Version and Release

on:
    release:
        types:
            - created

permissions:
    contents: write

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.release.tag_name }}
                  fetch-depth: 0

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: Install dependencies
              run: npm i

            - name: Get version from tag
              id: version
              run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

            - name: Update version in plugin file
              run: sed -i "s/__VERSION__/${{ steps.version.outputs.version }}/g" popup.php

            - name: Build
              run: npm run build

            - name: Commit version update
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add .
                  git commit -m "Update version to ${{ steps.version.outputs.version }}"

            - name: Update tag
              run: |
                  git tag -f ${{ github.event.release.tag_name }}
                  git push origin ${{ github.event.release.tag_name }} --force

            - name: Create plugin ZIP
              run: npm run plugin-zip

            - name: Upload release asset
              run: |
                  gh release upload ${{ github.event.release.tag_name }} popup.zip --clobber
              env:
                  GH_TOKEN: ${{ github.token }}
