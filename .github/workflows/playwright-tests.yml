name: Playwright E2E Tests

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php: ['8.3', '8.4']
                wp: ['6.8', '6.9', 'latest']

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: Install dependencies
              run: npm i

            - name: Build plugin
              run: npm run build

            - name: Install Playwright
              run: npx playwright install chromium

            - name: Start WordPress Playground
              run: |
                  npx --yes @wp-playground/cli@latest server start \
                    --blueprint=blueprint.json \
                    --port=9400 \
                    --php=${{ matrix.php }} \
                    --wp=${{ matrix.wp }} \
                    --auto-mount &
                  echo $! > playground.pid

            - name: Wait for Playground
              run: |
                  timeout 120 bash -c 'until curl -s http://localhost:9400 > /dev/null; do sleep 2; done'

            - name: Run E2E tests
              run: npm run test:e2e
              env:
                  WP_BASE_URL: http://localhost:9400
                  CI: true

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results-php${{ matrix.php }}-wp${{ matrix.wp }}
                  path: test-results/
                  retention-days: 30

            - name: Upload test artifacts
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: test-artifacts-php${{ matrix.php }}-wp${{ matrix.wp }}
                  path: playwright-report/
                  retention-days: 7

            - name: Stop Playground
              if: always()
              run: |
                  if [ -f playground.pid ]; then
                    kill $(cat playground.pid) || true
                  fi

            - name: Comment test results on PR
              if: github.event_name == 'pull_request' && always()
              uses: daun/playwright-report-summary@v3
              with:
                  report-file: test-results/results.json
                  comment-title: 'Playwright E2E Test Results (PHP ${{ matrix.php }}, WP ${{ matrix.wp }})'
